# Qlib 项目结构详细说明

## 项目概述
Qlib 是微软开发的面向 AI 的量化投资平台，支持从数据处理、模型训练到回测、实盘的完整量化投资流程。

## 根目录文件说明

### 配置文件
- **pyproject.toml** - 项目配置文件，定义依赖包、构建系统等
- **setup.py** - Python 包安装配置
- **Makefile** - 自动化构建脚本，包含测试、文档生成、代码检查等命令
- **.pylintrc** - Pylint 代码检查配置
- **.mypy.ini** - MyPy 类型检查配置
- **.pre-commit-config.yaml** - Git 提交前的代码检查配置
- **.readthedocs.yaml** - ReadTheDocs 文档自动构建配置

### 文档文件
- **README.md** - 项目主文档，包含安装说明和快速入门
- **CLAUDE.md** - Claude AI 使用本项目的指导文档
- **LICENSE** - MIT 开源协议
- **SECURITY.md** - 安全政策说明
- **CODE_OF_CONDUCT.md** - 社区行为准则
- **CHANGES.rst** / **CHANGELOG.md** - 版本更新日志

### 容器化
- **Dockerfile** - Docker 镜像构建文件
- **build_docker_image.sh** - Docker 镜像构建脚本
- **.dockerignore** - Docker 构建忽略文件

## 核心模块：qlib/

### 1. 数据层 (qlib/data/)
**作用**：处理所有数据相关操作，包括存储、读取、缓存和处理

#### 主要文件
- **base.py** - 数据表达式和操作的基类定义
- **data.py** - 核心数据提供器，支持本地/远程数据源
- **cache.py** - 多级缓存系统（内存、磁盘、Redis）
- **ops.py** - 数学和金融运算操作符，用于特征工程
- **filter.py** - 数据过滤和选择机制
- **pit.py** - Point-in-Time 数据处理，避免未来信息泄露

#### 子目录
- **dataset/** - 数据集处理和准备
  - `handler.py` - 数据处理器，负责特征和标签准备
  - `loader.py` - 数据加载器
  - `processor.py` - 数据预处理器（标准化、去极值等）
  - `weight.py` - 样本权重处理
- **storage/** - 数据存储后端
  - `file_storage.py` - 文件存储实现
  - `storage.py` - 存储抽象层
- **_libs/** - Cython 扩展，高性能数据操作
  - `rolling.pyx` - 滚动窗口计算
  - `expanding.pyx` - 扩展窗口计算

### 2. 模型层 (qlib/model/)
**作用**：机器学习模型抽象和训练基础设施

#### 主要文件
- **base.py** - 所有模型的基类，定义标准 fit/predict 接口
- **trainer.py** - 模型训练器，管理训练流程
- **utils.py** - 模型工具函数

#### 子目录
- **ens/** - 集成学习方法
  - `ensemble.py` - 集成模型基类
  - `group.py` - 分组集成
  - `rollingsplit.py` - 滚动分割集成
- **meta/** - 元学习框架
  - `dataset.py` - 元学习数据集
  - `model.py` - 元模型实现
  - `task.py` - 元任务定义
- **riskmodel/** - 风险模型
  - `base.py` - 风险模型基类
  - `structured.py` - 结构化风险模型
- **interpret/** - 模型解释工具
  - `base.py` - 解释器基类
  - `lightgbm.py` - LightGBM 模型解释

### 3. 策略层 (qlib/strategy/)
**作用**：交易策略实现和投资组合管理

#### 主要文件
- **base.py** - 策略基类，定义信号生成和仓位管理接口
- **rule_strategy.py** - 基于规则的策略实现

### 4. 回测层 (qlib/backtest/)
**作用**：投资组合模拟和绩效评估

#### 主要文件
- **exchange.py** - 市场模拟和订单撮合
- **executor.py** - 订单执行策略
- **account.py** - 账户管理和盈亏跟踪
- **position.py** - 持仓管理
- **backtest.py** - 回测引擎主程序
- **report.py** - 绩效报告生成
- **utils.py** - 回测工具函数
- **high_freq_strategy.py** - 高频策略支持
- **signal.py** - 交易信号处理

### 5. 工作流层 (qlib/workflow/)
**作用**：实验管理和端到端流程编排

#### 主要文件
- **__init__.py** - 工作流核心组件，包括 Recorder (R) 实验记录器
- **recorder.py** - 实验记录和 MLflow 集成
- **expm.py** - 实验管理器
- **exp.py** - 实验定义和执行
- **utils.py** - 工作流工具函数

#### 子目录
- **task/** - 任务管理
  - `gen.py` - 任务生成器
  - `manage.py` - 任务管理器
  - `utils.py` - 任务工具
- **online/** - 在线服务
  - `manager.py` - 在线模型管理
  - `strategy.py` - 在线策略执行
  - `update.py` - 模型更新机制
- **record_temp.py** - 记录模板
- **cli.py** - 命令行接口

### 6. 强化学习 (qlib/rl/)
**作用**：基于强化学习的交易策略和订单执行

#### 主要目录
- **data/** - RL 数据处理
  - `base.py` - 数据基类
  - `pickle_styled.py` - Pickle 格式数据
  - `integration.py` - 数据集成
- **order_execution/** - 订单执行优化
  - `simulator_qlib.py` - Qlib 模拟器
  - `simulator_simple.py` - 简单模拟器
  - `state.py` - 状态定义
  - `reward.py` - 奖励函数
  - `policy.py` - 执行策略
- **strategy/** - RL 策略
  - `base.py` - 策略基类
  - `single_order.py` - 单一订单策略
- **trainer/** - RL 训练器
  - `trainer.py` - 训练主程序
  - `vessel.py` - 训练容器
- **utils/** - RL 工具
  - `data_queue.py` - 数据队列
  - `env_wrapper.py` - 环境包装器
  - `log.py` - 日志工具

### 7. 贡献模块 (qlib/contrib/)
**作用**：社区贡献的模型、策略和工具

#### 主要目录
- **model/** - 30+ 个实现的模型
  - 机器学习：`gbdt.py`, `linear.py`, `catboost.py`, `xgboost.py`
  - 深度学习：`pytorch_lstm.py`, `pytorch_gru.py`, `pytorch_transformer.py`
  - 图神经网络：`pytorch_gats.py`
  - 表格模型：`pytorch_tabnet.py`
  - 时序模型：`tcn.py`, `adarnn.py`, `add.py`
  - 高频模型：`hist.py`
- **data/** - 数据处理器
  - `handler.py` - Alpha158, Alpha360 等特征集
  - `processor.py` - 数据预处理器
- **strategy/** - 交易策略
  - `signal_strategy.py` - 信号策略
  - `cost_control.py` - 成本控制
- **evaluate.py** - 评估指标
- **report/** - 报告生成
  - `analysis_model.py` - 模型分析
  - `analysis_position.py` - 持仓分析

### 8. 命令行接口 (qlib/cli/)
**作用**：提供命令行操作接口

- **run.py** - 主 CLI 入口，`qrun` 命令实现
- **data.py** - 数据管理命令

### 9. 工具模块 (qlib/utils/)
**作用**：通用工具函数和辅助功能

- **__init__.py** - 常用工具函数
- **time.py** - 时间处理工具
- **resam.py** - 重采样工具
- **paral.py** - 并行处理
- **mod.py** - 模块管理
- **index_data.py** - 指数数据处理
- **data.py** - 数据工具
- **decorator.py** - 装饰器
- **objm.py** - 对象管理

### 10. 测试模块 (qlib/tests/)
**作用**：内部测试工具

- **config.py** - 测试配置
- **data.py** - 测试数据生成
- **mock.py** - Mock 对象

## 示例目录：examples/

### 基准测试 (benchmarks/)
**作用**：25+ 个模型的标准化实现和比较
- 每个模型包含：
  - YAML 配置文件
  - requirements.txt 依赖
  - README.md 说明文档
- 模型示例：
  - 传统机器学习：LightGBM, XGBoost, CatBoost
  - 深度学习：LSTM, GRU, Transformer, TabNet
  - 图模型：GATs, RSR
  - 元学习：DDG-DA

### 教程 (tutorial/)
**作用**：入门教程和学习材料
- **detailed_workflow.ipynb** - 完整工作流程演示

### 专项示例
- **rl_order_execution/** - 强化学习订单执行优化
- **highfreq/** - 高频交易示例
- **nested_decision_execution/** - 嵌套决策框架
- **portfolio/** - 投资组合优化
- **model_rolling/** - 滚动模型更新
- **online_srv/** - 在线服务部署
- **orderbook_data/** - 订单簿数据处理
- **hyperparameter/** - 超参数优化

### 工作流示例
- **workflow_by_code.py** - Python 代码工作流
- **workflow_by_code.ipynb** - Jupyter notebook 工作流
- **run_all_model.py** - 批量运行所有模型

## 脚本目录：scripts/

### 数据管理脚本
- **get_data.py** - 下载市场数据
- **dump_bin.py** - 数据序列化和格式转换
- **check_data_health.py** - 数据质量检查
- **data_collector/** - 数据采集器
  - `yahoo/` - Yahoo Finance 数据
  - `alpha/` - Alpha 因子数据
  - `pit/` - Point-in-Time 数据
  - `utils.py` - 采集工具

### 基准脚本
- **benchmark/** - 基准测试脚本
- **run_all_model.py** - 运行所有模型基准

## 测试目录：tests/

### 测试组织结构
- **backtest/** - 回测系统测试
- **model/** - 模型实现测试
- **dataset_tests/** - 数据集处理测试
- **rl/** - 强化学习测试
- **ops/** - 数学运算测试
- **storage_tests/** - 数据存储测试
- **rolling_tests/** - 滚动窗口测试
- **dependency_tests/** - 依赖关系测试
- **misc/** - 其他测试

### 主要测试文件
- **test_workflow.py** - 工作流测试
- **test_pit.py** - Point-in-Time 数据测试
- **test_all_pipeline.py** - 完整流程测试
- **test_contrib_model.py** - 贡献模型测试
- **test_dump_data.py** - 数据导出测试
- **test_get_data.py** - 数据获取测试

### 测试配置
- **pytest.ini** - PyTest 配置
- **conftest.py** - 测试夹具定义

## 文档目录：docs/

### 文档结构
- **_static/** - 静态资源（图片、CSS）
- **_templates/** - 文档模板
- **component/** - 组件文档
- **tutorial/** - 教程文档
- **reference/** - API 参考
- **conf.py** - Sphinx 配置
- **index.rst** - 文档首页

## GitHub 工作流：.github/

### 工作流文件
- **workflows/test_qlib_from_source.yml** - 源码测试
- **workflows/test_qlib_from_pip.yml** - PyPI 安装测试
- **workflows/release.yml** - 自动发布
- **workflows/lint_title.yml** - PR 标题检查
- **workflows/stale.yml** - 过期 issue 管理

## 使用流程

### 1. 数据准备
使用 `scripts/get_data.py` 下载数据 → 存储到 `~/.qlib/` 目录

### 2. 模型开发
在 `qlib/contrib/model/` 实现模型 → 继承 `Model` 基类

### 3. 策略开发
在 `qlib/strategy/` 实现策略 → 定义信号生成逻辑

### 4. 回测验证
使用 `qlib/backtest/` 进行回测 → 生成绩效报告

### 5. 在线部署
通过 `qlib/workflow/online/` 部署 → 实时预测和交易

## 核心特性

- **多频率数据支持**：日频、分钟级数据
- **避免未来信息泄露**：Point-in-Time 数据处理
- **灵活的数据源**：本地、远程、NFS
- **多级缓存**：内存、磁盘、Redis
- **丰富的特征工程**：100+ 内置运算符
- **模型库**：25+ 实现的模型
- **实验管理**：MLflow 集成
- **完整回测框架**：支持高频交易
- **在线服务**：模型自动滚动更新

这个项目是一个生产级的量化金融平台，强调研究的可重复性、模型的标准化和可扩展的部署。